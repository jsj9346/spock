<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spock Trading System - Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e4e7eb;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .status-card {
            flex: 1;
            min-width: 200px;
            background: #1a1f2e;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .status-card.healthy {
            border-left-color: #10b981;
        }

        .status-card.warning {
            border-left-color: #f59e0b;
        }

        .status-card.critical {
            border-left-color: #ef4444;
        }

        .status-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .status-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .status-subtitle {
            font-size: 13px;
            opacity: 0.6;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2d3748;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-healthy {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .badge-critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #2d3748;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 14px;
            opacity: 0.8;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .progress-fill.healthy {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .progress-fill.critical {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .alert-list {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #2d3748;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .alert-icon.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .alert-icon.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .alert-text {
            flex: 1;
            font-size: 14px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .timestamp {
            text-align: center;
            opacity: 0.6;
            font-size: 12px;
            margin-top: 20px;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .region-card {
            background: #2d3748;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .region-name {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .region-value {
            font-size: 20px;
            font-weight: 600;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .status-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Spock Trading System</h1>
            <div class="subtitle">Real-Time Monitoring Dashboard ‚Ä¢ Phase 3 Validation & Monitoring</div>
        </header>

        <div id="dashboard-content">
            <div class="error-message">
                <h2>Loading metrics...</h2>
                <p>Please wait while we fetch the latest data.</p>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        // Dashboard configuration
        const METRICS_FILE = '../metrics_reports/metrics_latest.json';
        const REFRESH_INTERVAL = 30000; // 30 seconds

        // Fetch and display metrics
        async function loadMetrics() {
            try {
                const response = await fetch(METRICS_FILE);
                if (!response.ok) {
                    throw new Error('Failed to load metrics file');
                }

                const metrics = await response.json();
                renderDashboard(metrics);
                updateTimestamp(metrics.timestamp);
            } catch (error) {
                console.error('Error loading metrics:', error);
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="error-message">
                        <h2>‚ùå Error Loading Metrics</h2>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; opacity: 0.8;">
                            Please ensure metrics collection is running and the metrics file exists at:<br>
                            <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px;">
                                ${METRICS_FILE}
                            </code>
                        </p>
                        <button class="refresh-btn" style="margin-top: 20px;" onclick="loadMetrics()">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }

        function renderDashboard(metrics) {
            const summary = calculateSummary(metrics);

            const html = `
                <!-- Status Bar -->
                <div class="status-bar">
                    <div class="status-card ${summary.overallStatus}">
                        <div class="status-label">Overall Health</div>
                        <div class="status-value">${summary.overallHealth}/100</div>
                        <div class="status-subtitle">${summary.overallStatus.toUpperCase()}</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">API Requests</div>
                        <div class="status-value">${metrics.api.total_requests.toLocaleString()}</div>
                        <div class="status-subtitle">${metrics.api.error_rate.toFixed(1)}% error rate</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Database</div>
                        <div class="status-value">${(metrics.database.total_rows / 1000).toFixed(0)}K</div>
                        <div class="status-subtitle">${metrics.database.database_size_mb.toFixed(1)} MB</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">System Load</div>
                        <div class="status-value">${metrics.system.cpu.usage_pct.toFixed(1)}%</div>
                        <div class="status-subtitle">CPU Usage</div>
                    </div>
                </div>

                <!-- Alerts -->
                ${renderAlerts(summary)}

                <!-- Metrics Grid -->
                <div class="grid">
                    <!-- API Metrics -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üì° API Performance</div>
                            <span class="card-badge badge-${summary.apiStatus}">${summary.apiStatus.toUpperCase()}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Total Requests</span>
                            <span class="metric-value">${metrics.api.total_requests.toLocaleString()}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Success Rate</span>
                            <span class="metric-value">${(100 - metrics.api.error_rate).toFixed(1)}%</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Avg Latency</span>
                            <span class="metric-value">${(metrics.api.avg_latency_ms || 0).toFixed(1)} ms</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">P95 Latency</span>
                            <span class="metric-value">${metrics.api.p95_latency_ms.toFixed(1)} ms</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Rate Limit Usage</span>
                            <span class="metric-value">${metrics.api.rate_limit_usage_pct.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressStatus(metrics.api.rate_limit_usage_pct)}"
                                 style="width: ${metrics.api.rate_limit_usage_pct}%"></div>
                        </div>
                    </div>

                    <!-- Database Metrics -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üíæ Database Health</div>
                            <span class="card-badge badge-${summary.dbStatus}">${summary.dbStatus.toUpperCase()}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Total Rows</span>
                            <span class="metric-value">${metrics.database.total_rows.toLocaleString()}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Database Size</span>
                            <span class="metric-value">${metrics.database.database_size_mb.toFixed(1)} MB</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Avg Row Size</span>
                            <span class="metric-value">${metrics.database.avg_row_size_bytes} bytes</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Query Performance</span>
                            <span class="metric-value">${getAvgQueryTime(metrics.database.query_performance)} ms</span>
                        </div>

                        <div class="region-grid">
                            ${Object.entries(metrics.database.rows_by_region).map(([region, count]) => `
                                <div class="region-card">
                                    <div class="region-name">${region}</div>
                                    <div class="region-value">${(count / 1000).toFixed(count >= 1000 ? 0 : 1)}K</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Data Quality -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚úì Data Quality</div>
                            <span class="card-badge badge-${summary.dqStatus}">${summary.dqStatus.toUpperCase()}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Critical NULL Values</span>
                            <span class="metric-value">${getCriticalNulls(metrics.data_quality.null_rates)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Integrity Violations</span>
                            <span class="metric-value">${metrics.data_quality.integrity_violations.total}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Contamination Issues</span>
                            <span class="metric-value">${getContaminationCount(metrics.data_quality.contamination)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Avg Completeness</span>
                            <span class="metric-value">${getAvgCompleteness(metrics.data_quality.completeness)}%</span>
                        </div>
                    </div>

                    <!-- System Resources -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üñ•Ô∏è System Resources</div>
                            <span class="card-badge badge-${summary.systemStatus}">${summary.systemStatus.toUpperCase()}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">CPU Usage</span>
                            <span class="metric-value">${metrics.system.cpu.usage_pct.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressStatus(metrics.system.cpu.usage_pct)}"
                                 style="width: ${metrics.system.cpu.usage_pct}%"></div>
                        </div>

                        <div class="metric-row" style="margin-top: 15px;">
                            <span class="metric-label">Memory Usage</span>
                            <span class="metric-value">${metrics.system.memory.usage_pct.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressStatus(metrics.system.memory.usage_pct)}"
                                 style="width: ${metrics.system.memory.usage_pct}%"></div>
                        </div>

                        <div class="metric-row" style="margin-top: 15px;">
                            <span class="metric-label">Disk Usage</span>
                            <span class="metric-value">${metrics.system.disk.usage_pct.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressStatus(metrics.system.disk.usage_pct)}"
                                 style="width: ${metrics.system.disk.usage_pct}%"></div>
                        </div>

                        <div class="metric-row" style="margin-top: 15px;">
                            <span class="metric-label">Memory Available</span>
                            <span class="metric-value">${metrics.system.memory.available_mb.toFixed(0)} MB</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Disk Free</span>
                            <span class="metric-value">${metrics.system.disk.free_gb.toFixed(1)} GB</span>
                        </div>
                    </div>
                </div>

                <!-- Refresh Button -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="refresh-btn" onclick="loadMetrics()">üîÑ Refresh Metrics</button>
                </div>
            `;

            document.getElementById('dashboard-content').innerHTML = html;
        }

        function calculateSummary(metrics) {
            const apiHealth = metrics.api.error_rate < 5 ? 100 : metrics.api.error_rate < 20 ? 75 : 50;
            const dbHealth = Object.values(metrics.database.query_performance).every(q => q.status === 'healthy') ? 100 : 85;
            const dqHealth = metrics.data_quality.integrity_violations.total === 0 && getCriticalNulls(metrics.data_quality.null_rates) === 0 ? 100 : 80;
            const systemHealth = metrics.system.cpu.usage_pct < 70 && metrics.system.memory.usage_pct < 70 && metrics.system.disk.usage_pct < 80 ? 100 : 80;

            const overallHealth = Math.round((apiHealth + dbHealth + dqHealth + systemHealth) / 4);

            return {
                overallHealth,
                overallStatus: overallHealth >= 90 ? 'healthy' : overallHealth >= 75 ? 'warning' : 'critical',
                apiStatus: apiHealth >= 90 ? 'healthy' : apiHealth >= 75 ? 'warning' : 'critical',
                dbStatus: dbHealth >= 90 ? 'healthy' : dbHealth >= 75 ? 'warning' : 'critical',
                dqStatus: dqHealth >= 90 ? 'healthy' : dqHealth >= 75 ? 'warning' : 'critical',
                systemStatus: systemHealth >= 90 ? 'healthy' : systemHealth >= 75 ? 'warning' : 'critical',
                alerts: generateAlerts(metrics)
            };
        }

        function generateAlerts(metrics) {
            const alerts = [];

            if (metrics.api.error_rate > 20) {
                alerts.push({ level: 'critical', message: `Critical API error rate: ${metrics.api.error_rate.toFixed(1)}%` });
            } else if (metrics.api.error_rate > 5) {
                alerts.push({ level: 'warning', message: `High API error rate: ${metrics.api.error_rate.toFixed(1)}%` });
            }

            if (metrics.system.cpu.usage_pct > 85) {
                alerts.push({ level: 'critical', message: `Critical CPU usage: ${metrics.system.cpu.usage_pct.toFixed(1)}%` });
            } else if (metrics.system.cpu.usage_pct > 70) {
                alerts.push({ level: 'warning', message: `High CPU usage: ${metrics.system.cpu.usage_pct.toFixed(1)}%` });
            }

            if (metrics.system.memory.usage_pct > 85) {
                alerts.push({ level: 'critical', message: `Critical memory usage: ${metrics.system.memory.usage_pct.toFixed(1)}%` });
            } else if (metrics.system.memory.usage_pct > 70) {
                alerts.push({ level: 'warning', message: `High memory usage: ${metrics.system.memory.usage_pct.toFixed(1)}%` });
            }

            if (metrics.system.disk.usage_pct > 90) {
                alerts.push({ level: 'critical', message: `Critical disk usage: ${metrics.system.disk.usage_pct.toFixed(1)}%` });
            } else if (metrics.system.disk.usage_pct > 80) {
                alerts.push({ level: 'warning', message: `High disk usage: ${metrics.system.disk.usage_pct.toFixed(1)}%` });
            }

            const criticalNulls = getCriticalNulls(metrics.data_quality.null_rates);
            if (criticalNulls > 0) {
                alerts.push({ level: 'critical', message: `${criticalNulls} critical NULL values detected` });
            }

            const violations = metrics.data_quality.integrity_violations.total;
            if (violations > 0) {
                alerts.push({ level: 'warning', message: `${violations} data integrity violations` });
            }

            return alerts;
        }

        function renderAlerts(summary) {
            if (summary.alerts.length === 0) {
                return '';
            }

            return `
                <div class="alert-list">
                    <div class="card-header">
                        <div class="card-title">üö® Alerts (${summary.alerts.length})</div>
                    </div>
                    ${summary.alerts.map(alert => `
                        <div class="alert-item">
                            <div class="alert-icon ${alert.level}">${alert.level === 'critical' ? '!' : '‚ö†'}</div>
                            <div class="alert-text">${alert.message}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getCriticalNulls(nullRates) {
            return Object.values(nullRates).filter(r => r.status === 'critical').length;
        }

        function getContaminationCount(contamination) {
            return Object.values(contamination).reduce((sum, c) => sum + c.violations, 0);
        }

        function getAvgCompleteness(completeness) {
            const values = Object.values(completeness).map(c => c.completeness_pct);
            return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : 0;
        }

        function getAvgQueryTime(queryPerf) {
            const times = Object.values(queryPerf).map(q => q.latency_ms);
            return times.length > 0 ? (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1) : 0;
        }

        function getProgressStatus(percentage) {
            if (percentage < 70) return 'healthy';
            if (percentage < 85) return 'warning';
            return 'critical';
        }

        function updateTimestamp(timestamp) {
            const date = new Date(timestamp);
            document.getElementById('timestamp').textContent = `Last updated: ${date.toLocaleString()}`;
        }

        // Initialize dashboard
        loadMetrics();

        // Auto-refresh
        setInterval(loadMetrics, REFRESH_INTERVAL);
    </script>
</body>
</html>
